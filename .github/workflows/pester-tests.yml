name: PowerShell Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
          
      - name: Install Pester
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -Force -RequiredVersion 5.6.1 -SkipPublisherCheck

      - name: Install ImageMagick and Ghostscript for E2E tests
        shell: pwsh
        run: |
          Write-Host "Installing ImageMagick and Ghostscript for E2E testing..."
          choco install imagemagick ghostscript -y --no-progress

          Write-Host "Refreshing environment variables..."
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

          Write-Host "Tools installed. Verifying..."
          magick --version

          # Ghostscript might be gs, gsc, or gswin64c depending on installation
          $gsCommands = @('gswin64c', 'gs', 'gsc')
          $gsFound = $false
          foreach ($cmd in $gsCommands) {
            if (Get-Command $cmd -ErrorAction SilentlyContinue) {
              Write-Host "Found Ghostscript: $cmd"
              & $cmd --version
              $gsFound = $true
              break
            }
          }

          if (-not $gsFound) {
            Write-Warning "Ghostscript installed but executable not found in PATH. It may still work in tests."
          }

      - name: Run Pester Tests
        shell: pwsh
        run: |
          # Refresh PATH to include newly installed tools
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

          Import-Module Pester -RequiredVersion 5.6.1

          $pesterConfig = New-PesterConfiguration
          $pesterConfig.Run.Path = "./tests"
          $pesterConfig.Run.PassThru = $true
          $pesterConfig.Output.Verbosity = "Detailed"
          $pesterConfig.TestResult.Enabled = $true
          $pesterConfig.TestResult.OutputFormat = "NUnitXml"
          $pesterConfig.TestResult.OutputPath = "testResults.xml"

          $result = Invoke-Pester -Configuration $pesterConfig

          if ($result.FailedCount -gt 0) {
              throw "Pester tests failed"
          }
          
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: testResults.xml
